<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document</title>
  <link rel="stylesheet" href="style.css">
  <script src="./Cell.js"></script>
  <script src="./MiniCell.js"></script>
  <script>
    let cellArray = Array.from({ length: 6 }, () => Array(7).fill(0));
    let restArray = []; // ê³µíœ´ì¼ ë°°ì—´
    let diaryArray = []; // ì‚¬ìš©ì plan ë°°ì—´
    let currentYear;
    let currentMonth;
    let currentCell;

    function getCurrentTime(year, month) {
      let d = new Date(year, month);
      currentYear = d.getFullYear();
      currentMonth = d.getMonth();
    }

    function getStartDay(year, month) {
      let d = new Date(year, month, 1);
      return d.getDay();
    }

    function getLastDate(year, month) {
      let d = new Date(year, month + 1, 0);
      return d.getDate();
    }

    function checkData(cell, year, month, date) {
      for (let k = 0; k < restArray.length; k++) {
        let rest = restArray[k];
       
        if (rest.year == year && rest.month == month && rest.date == date) {
          cell.restDiv.innerText = rest.title;
          cell.restDiv.style.textAlign = "right";
          cell.restDiv.style.color = "red";
          cell.setDateColor("red");
          // cell.renderIcon(rest.icon, 50); ê³µíœ´ì¼ì€ ìŠ¤í‹°ì»¤ ì œê±°
        }
      
      }
      for (let j=0; j< diaryArray.length; j++){
        let diary = diaryArray[j];
          if (diary.year == year && diary.month == month && diary.date == date) {
           cell.titleDiv.innerText = diary.title;
           cell.renderIcon(diary.icon, 35); //ê³µíœ´ì¼ì€ ìŠ¤í‹°ì»¤ ì œê±°
         }
      }
    }

    function printNum() {
      let index = 0;
      let date = 1;
      for (let i = 0; i < cellArray.length; i++) {
        for (let j = 0; j < cellArray[0].length; j++) {
          if (index >= getStartDay(currentYear, currentMonth) &&
              date <= getLastDate(currentYear, currentMonth)) {
            cellArray[i][j].setDate(currentYear, currentMonth, date);
            cellArray[i][j].setDateColor("black"); // ê³µíœ´ì¼ setRed ì´ˆê¸°í™”
            checkData(cellArray[i][j], currentYear, currentMonth, date);
            date++;
          }
          if(j % 7 == 0 ) cellArray[i][j].setDateColor("red");
          index++;
        }
      }
    }

    function clearCell() {
      for (let i = 0; i < cellArray.length; i++) {
        for (let j = 0; j < cellArray[0].length; j++) {
          cellArray[i][j].numDiv.innerText = "";
          cellArray[i][j].titleDiv.innerText = "";
          cellArray[i][j].restDiv.innerText = "";
            if (cellArray[i][j].iconDiv.children.length > 0) {
              cellArray[i][j].iconDiv.removeChild(cellArray[i][j].icon);
            }
        }
      }
    }

    function prev() {
      getCurrentTime(currentYear, currentMonth - 1);
      printTitle();
      clearCell();
      printNum();
    }

    function next() {
      getCurrentTime(currentYear, currentMonth + 1);
      printTitle();
      clearCell();
      printNum();
    }

    function createDayHeaders() {
      let days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      let container = document.getElementById("date_print");
      let headerHeight = 20;
      let c_width = 1680 / 7;

      for (let i = 0; i < days.length; i++) {
        let dayDiv = document.createElement("div");
        if (i == 0) dayDiv.style.color = "red";
        if (i == days.length - 1) dayDiv.style.color = "blue";
        dayDiv.innerText = days[i];
        dayDiv.style.position = "absolute";
        dayDiv.style.left = `${i * c_width}px`;
        dayDiv.style.top = "0px";
        dayDiv.style.textAlign = "right";
        dayDiv.style.padding = "0px 5px 0px 0px";
        dayDiv.style.width = `${c_width}px`;
        dayDiv.style.lineHeight = `${headerHeight}px`;
        dayDiv.style.height = `${headerHeight}px`;
        dayDiv.style.backgroundColor = "white";
        dayDiv.style.borderTop = "1px solid lightgray";
        dayDiv.style.borderLeft = "1px solid lightgray";
        dayDiv.style.borderRight = "1px solid lightgray";
        dayDiv.style.boxSizing = "border-box"; 
        container.appendChild(dayDiv);
      }
    }

    function printTitle() {
      let inner = currentMonth < 9 ? ".0" : ".";
      document.querySelector("#content_header h2").innerText =
        `${currentYear}${inner}${currentMonth + 1}`;
    }

    function createCell() {
      for (let i = 0; i < cellArray.length; i++) {
        for (let j = 0; j < cellArray[0].length; j++) {
          let c_width = 1680 / 7;
          let c_height = 760 / 6;
          let cell = new Cell(
            document.getElementById("content_section"),
            j * c_width, i * c_height,
            c_width, c_height,
            "white", "lightgray", 0
          );
          cellArray[i][j] = cell;
        }
      }
    }

    // ì…€ ë³´ì—¬ì£¼ê¸°
    function cellPrint(){
      document.getElementById("content_header").style.display ="block";
      document.getElementById("date_print").style.display ="block";
      document.getElementById("content_section").style.display ="block";
      document.getElementById("holder_header").style.display ="none";
      document.getElementById("holder").style.display ="none";
    }

    // ë“±ë¡ í¼ ë³´ì—¬ì£¼ê¸°
    function formPrint(obj){
      document.getElementById("content_header").style.display ="none";
      document.getElementById("date_print").style.display ="none";
      document.getElementById("content_section").style.display ="none";
      document.getElementById("holder_header").style.display ="block";
      document.getElementById("holder").style.display ="block";

      currentCell = obj;
    }
    
    // ìˆ¨ê²¨ì ¸ ìˆë˜, ëŒ€í™”ì°½ì„ ë„ìš°ë˜, ê·¸ ìœ„ì¹˜ëŠ” ì§€ê¸ˆ í´ë¦­í•œ ë°”ë¡œ ê·¸ ì…€ì˜ x,yë¥¼
    // ë”°ë¼ê°€ì•¼í•¨..
    function openDialog(obj) {
      console.log(obj);
      // í˜„ì¬ ë‹¤ì´ì–´ë¡œê·¸ì— ëŒ€í•œ objê°’
        let dialog = document.getElementById("dialog");
        dialog.style.display = "block";
        
        // íŒì—…ì˜ ìœ„ì¹˜ëŠ” ì‚¬ìš©ìê°€ í´ë¦­í•œ ì…€ì˜ ì¢Œí‘œ ë°”ë¡œ ì•„ë˜ì¹¸ì—  ì¼ì¹˜ì‹œí‚¤ì
        dialog.style.left = obj.x + "px";
        dialog.style.top = obj.y + "px";
        dialog.style.background = "gray";
        
        // ë„˜ê²¨ë°›ì€ x, yë¥¼ ì´ìš©í•˜ì—¬ ìƒˆ ì°½ì˜ ìœ„ì¹˜ë¥¼ ê²°ì •ì§“ì
        dialog.style.position = "absolute";
        dialog.style.zIndex = 9999;

        dialog.querySelector(".mini-popup h4").textContent = "ì¼ì •";

        dialog.querySelector(".mini-popup .info:nth-of-type(1)").innerHTML = `
          <span class="label">ì œëª©:</span><br />
          ${obj.title || "ì œëª© ì—†ìŒ"}
        `;

        dialog.querySelector(".mini-popup .info:nth-of-type(2)").innerHTML = `
          <span class="label">ì¥ì†Œ:</span><br />
          ${obj.place || "ì¥ì†Œ ì—†ìŒ"}
        `;

        dialog.querySelector(".mini-popup .info:nth-of-type(3)").innerHTML = `
          <span class="label">ë©”ëª¨:</span><br />
          ${obj.description || "ë©”ëª¨ ì—†ìŒ"}
        `;
    }
    
    function closeDialog(){
      document.getElementById("dialog").style.display = "none";
    }
      
    // ì¼ì • ë“±ë¡ í¼
    function regist(){
      let diary = {
        year : currentYear,
        month : currentMonth,
        date : currentCell.date,
        title : form1.title.value,
        place : form1.place.value,
        description : form1.description.value,
        icon: "./images/noteImg.png",
      };

      // searchDiary() => ê°™ì€ ë‚ ì— minicellì´ ìˆì„ ì‹œ mn_y = 24;
      let mn_y = 0; //  mn_y += 24;

      let minicell = new MiniCell(
          currentCell.titleDiv,
          currentCell.x + 50, currentCell.y + 68 + mn_y,
          "lightblue", "white", 
          form1.title.value,
          form1.place.value,
          form1.description.value, currentCell.date
      );
      console.log(minicell);

      diaryArray.push(diary);
      
      form1.reset();
      // div none ë°”ê¿”ì£¼ê¸°
      cellPrint();
      // currentCell.titleDiv.innerText = diary.title;
      currentCell.renderIcon(diary.icon, 35); //ê³µíœ´ì¼ì€ ìŠ¤í‹°ì»¤ ì œê±°
    }


    addEventListener("load", function () {
      let d = new Date();
      getCurrentTime(d.getFullYear(), d.getMonth());
      printTitle();
      createDayHeaders();
      createCell();

      document.getElementById("save_diary").addEventListener("click", function(){
        regist();
      });

        // ìƒˆ ì°½ ë‹«ê¸° ì´ë²¤íŠ¸ êµ¬í˜„
      document.getElementById("delete-dial").addEventListener("click", () => {
        closeDialog();
      });

      fetch("./data.txt")
        .then(response => response.text())
        .then(text => {
          let obj = JSON.parse(text);
          restArray = obj.restList;
          printNum();
        })
        .catch(err => {
          console.error("ê³µíœ´ì¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", err);
          printNum(); // ë°ì´í„°ê°€ ì—†ì–´ë„ ì¶œë ¥ì€ í•´ì•¼ í•¨
        });

    });
  </script>
</head>
<body>
  <div id="wrapper">
    <div id="header"></div>
    <div id="container">
      <div id="aside_nav"></div>
      <div id="content">
        <div id="content_header">
          <a href="javascript:prev()">ì´ì „</a>
          <h2>1999.02</h2>
          <a href="javascript:next()">ë‹¤ìŒ</a>
          <button id="btn-today">ì˜¤ëŠ˜</button>
        </div>
        <div id="date_print" ></div> 
        <div id="content_section">
          <div id="dialog" style="display: none;">
             <div class="mini-popup">
                <h4>ì¼ì •</h4>
                <div class="info">
                  <span class="label">ì œëª©:</span><br />
                  ë‚˜ëŠ”ì œëª©
                </div>
                <div class="info">
                  <span class="label">ì¥ì†Œ:</span><br />
                  ë‚˜ëŠ”ì¥ì†Œ
                </div>
                <div class="info">
                  <span class="label">ë©”ëª¨:</span><br />
                  ë‚˜ëŠ”ë””í…Œì¼
                </div>
                <button id="delete-dial">ì‚­ì œ</button>
                <button id="detail-dial">ìƒì„¸ ì •ë³´</button>
            </div>  
          </div>
        </div>
        <div id="holder_header"></div>
        <div id="holder" style="display: none;">
          <form id="event-form" name="form1">
            <h3>ìƒˆë¡œìš´ ì¼ì • ë“±ë¡</h3>

            <label>
              ì œëª©  
              <input type="text" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
            </label>

            <label>
              ì¥ì†Œ  
              <select name="place">
                <option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì„œìš¸íŠ¹ë³„ì‹œ">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                <option value="ë¶€ì‚°ê´‘ì—­ì‹œ">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
                <option value="ëŒ€êµ¬ê´‘ì—­ì‹œ">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
                <option value="ì¸ì²œê´‘ì—­ì‹œ">ì¸ì²œê´‘ì—­ì‹œ</option>
                <option value="ê´‘ì£¼ê´‘ì—­ì‹œ">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
                <option value="ëŒ€ì „ê´‘ì—­ì‹œ">ëŒ€ì „ê´‘ì—­ì‹œ</option>
                <option value="ìš¸ì‚°ê´‘ì—­ì‹œ">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
                <option value="ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
                <option value="ê²½ê¸°ë„">ê²½ê¸°ë„</option>
                <option value="ê°•ì›íŠ¹ë³„ìì¹˜ë„">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
                <option value="ì¶©ì²­ë¶ë„">ì¶©ì²­ë¶ë„</option>
                <option value="ì¶©ì²­ë‚¨ë„">ì¶©ì²­ë‚¨ë„</option>
                <option value="ì „ë¼ë¶ë„">ì „ë¼ë¶ë„</option>
                <option value="ì „ë¼ë‚¨ë„">ì „ë¼ë‚¨ë„</option>
                <option value="ê²½ìƒë¶ë„">ê²½ìƒë¶ë„</option>
                <option value="ê²½ìƒë‚¨ë„">ê²½ìƒë‚¨ë„</option>
                <option value="ì œì£¼íŠ¹ë³„ìì¹˜ë„">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
              </select>
            </label>

            <label>
              ì„¤ëª…  
              <textarea name="description" rows="5" placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </label>

            <div class="form-buttons">
              <button type="button" class="save-btn" id="save_diary">ğŸ’¾ ì €ì¥</button>
              <button type="button" class="cancel-btn" onclick="closeHolder()">ì·¨ì†Œ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div id="footer">
    </div>
  </div>
</body>
</html>
