<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document</title>
  <link rel="stylesheet" href="style.css">
  <script src="./Cell.js"></script>
  <script src="./MiniCell.js"></script>
  <script>
    let cellArray = Array.from({ length: 6 }, () => Array(7).fill(0));
    let restArray = []; // 공휴일 배열
    let diaryArray = []; // 사용자 plan 배열
    let currentYear;
    let currentMonth;
    let currentCell;

    function getCurrentTime(year, month) {
      let d = new Date(year, month);
      currentYear = d.getFullYear();
      currentMonth = d.getMonth();
    }

    function getStartDay(year, month) {
      let d = new Date(year, month, 1);
      return d.getDay();
    }

    function getLastDate(year, month) {
      let d = new Date(year, month + 1, 0);
      return d.getDate();
    }

    function checkData(cell, year, month, date) {
      for (let k = 0; k < restArray.length; k++) {
        let rest = restArray[k];
       
        if (rest.year == year && rest.month == month && rest.date == date) {
          cell.restDiv.innerText = rest.title;
          cell.restDiv.style.textAlign = "right";
          cell.restDiv.style.color = "red";
          cell.setDateColor("red");
          // cell.renderIcon(rest.icon, 50); 공휴일은 스티커 제거
        }
      }
    }
    function printIcon(cell, year, month, date){
      for (let j=0; j< diaryArray.length; j++){
        let diary = diaryArray[j];
          if (diary.year == year && diary.month == month && diary.date == date) {
           cell.renderIcon(diary.icon, 35); //공휴일은 스티커 제거
         }
      }
    }

    function printNum() {
      let index = 0;
      let date = 1;
      for (let i = 0; i < cellArray.length; i++) {
        for (let j = 0; j < cellArray[0].length; j++) {
          if (index >= getStartDay(currentYear, currentMonth) &&
              date <= getLastDate(currentYear, currentMonth)) {
            cellArray[i][j].setDate(currentYear, currentMonth, date);
            cellArray[i][j].setDateColor("black"); // 공휴일 setRed 초기화
            checkData(cellArray[i][j], currentYear, currentMonth, date);
            printIcon(cellArray[i][j], currentYear, currentMonth, date);
            date++;
          }
          if(j % 7 == 0 ) cellArray[i][j].setDateColor("red");
          index++;
        }
      }
    }

    function clearCell() {
      for (let i = 0; i < cellArray.length; i++) {
        for (let j = 0; j < cellArray[0].length; j++) {
          cellArray[i][j].numDiv.innerText = "";
          cellArray[i][j].titleDiv.innerText = "";
          cellArray[i][j].restDiv.innerText = "";
            if (cellArray[i][j].iconDiv.children.length > 0) {
              cellArray[i][j].iconDiv.removeChild(cellArray[i][j].icon);
            }
        }
      }
    }

    function prev() {
      getCurrentTime(currentYear, currentMonth - 1);
      printTitle();
      clearCell();
      printNum();
      miniCellPrint();
    }

    function now(){
      let d = new Date();
      getCurrentTime(d.getFullYear(), d.getMonth());
      printTitle();
      clearCell();
      printNum();
      miniCellPrint();
    }

    function next() {
      getCurrentTime(currentYear, currentMonth + 1);
      printTitle();
      clearCell();
      printNum();
      miniCellPrint();
    }

    function createDayHeaders() {
      let days = ['일', '월', '화', '수', '목', '금', '토'];
      let container = document.getElementById("date_print");
      let headerHeight = 20;
      let c_width = 1680 / 7;

      for (let i = 0; i < days.length; i++) {
        let dayDiv = document.createElement("div");
        if (i == 0) dayDiv.style.color = "red";
        if (i == days.length - 1) dayDiv.style.color = "blue";
        dayDiv.innerText = days[i];
        dayDiv.style.position = "absolute";
        dayDiv.style.left = `${i * c_width}px`;
        dayDiv.style.top = "0px";
        dayDiv.style.textAlign = "right";
        dayDiv.style.padding = "0px 5px 0px 0px";
        dayDiv.style.width = `${c_width}px`;
        dayDiv.style.lineHeight = `${headerHeight}px`;
        dayDiv.style.height = `${headerHeight}px`;
        dayDiv.style.backgroundColor = "white";
        dayDiv.style.borderTop = "1px solid lightgray";
        dayDiv.style.borderLeft = "1px solid lightgray";
        dayDiv.style.borderRight = "1px solid lightgray";
        dayDiv.style.boxSizing = "border-box"; 
        container.appendChild(dayDiv);
      }
    }

    function printTitle() {
      let inner = currentMonth < 9 ? ".0" : ".";
      document.querySelector("#content_header h2").innerText =
        `${currentYear}${inner}${currentMonth + 1}`;
    }

    function createCell() {
      for (let i = 0; i < cellArray.length; i++) {
        for (let j = 0; j < cellArray[0].length; j++) {
          let c_width = 1680 / 7;
          let c_height = 760 / 6;
          let cell = new Cell(
            document.getElementById("content_section"),
            j * c_width, i * c_height,
            c_width, c_height,
            "white", "lightgray", 0
          );
          cellArray[i][j] = cell;
        }
      }
    }

    function findCellByDate(date) {
      for (let i = 0; i < cellArray.length; i++) {
        for (let j = 0; j < cellArray[0].length; j++) {
          if (cellArray[i][j].date === parseInt(date)) {
            return cellArray[i][j];
          }
        }
      }
      return null;
    }

    // 셀 보여주기
      function miniCellPrint() {
      // 먼저 전체 달력 초기화
      for (let i = 0; i < cellArray.length; i++) {
        for (let j = 0; j < cellArray[0].length; j++) {
          cellArray[i][j].clearMiniCells(); // 미니셀 초기화
        }
      }

      // 현재 달에 해당하는 일기만 다시 그리기
      for (let i = 0; i < diaryArray.length; i++) {
        const d = diaryArray[i];
        if (d.year === currentYear && d.month === currentMonth) {
          const cell = findCellByDate(d.date); // 해당 날짜의 셀 찾기

          if (cell) {
            let minicell = new MiniCell(
              cell.titleDiv,
              cell.x + 50,
              cell.y + 68,
              "#476581",
              "white",
              d.title,
              d.place,
              d.description,
              d.date,
              cell
            );
          }
        }
      }
      
      // 등록 폼 숨기기
      document.getElementById("content_header").style.display ="block";
      document.getElementById("date_print").style.display ="block";
      document.getElementById("content_section").style.display ="block";
      document.getElementById("holder_header").style.display ="none";
      document.getElementById("holder").style.display ="none";
    }
    
    function regist() {
      const year = parseInt(form1.year.value);
      const month = parseInt(form1.month.value);
      const date = parseInt(form1.date.value);

      if (!year || !month || !date) {
        alert("년, 월, 일을 모두 선택해주세요.");
        return;
      }

      const diary = {
        year: year,
        month: month-1,
        date: date,
        title: form1.title.value,
        place: form1.place.value,
        description: form1.description.value,
        icon: "./images/noteImg.png",
      };

      diaryArray.push(diary);

      form1.reset();

      // holder 숨기고, 달력 리렌더링
      miniCellPrint();
    }
    
    
    // 등록 폼 보여주기
    function formPrint(obj){
      document.getElementById("content_header").style.display ="none";
      document.getElementById("date_print").style.display ="none";
      document.getElementById("content_section").style.display ="none";
      document.getElementById("holder_header").style.display ="block";
      document.getElementById("holder").style.display ="block";
      
      currentCell = obj;
    }
    
    // 숨겨져 있던, 대화창을 띄우되, 그 위치는 지금 클릭한 바로 그 셀의 x,y를
    // 따라가야함..
    function openDialog(obj) {
      // 현재 다이어로그에 대한 obj값
        let dialog = document.getElementById("dialog");
        dialog.style.display = "block";
        
        // 팝업의 위치는 사용자가 클릭한 셀의 좌표 바로 아래칸에  일치시키자
        dialog.style.left = obj.x + "px";
        dialog.style.top = obj.y + "px";
        dialog.style.background = "gray";
        
        // 넘겨받은 x, y를 이용하여 새 창의 위치를 결정짓자
        dialog.style.position = "absolute";
        dialog.style.zIndex = 9999; // 맨 앞으로 이동 - zIndex

        dialog.querySelector(".mini-popup h4").textContent = "일정";

        dialog.querySelector(".mini-popup .info:nth-of-type(1)").innerHTML = `
          <span class="label">제목:</span><br />
          ${obj.title || "제목 없음"}
        `;

        dialog.querySelector(".mini-popup .info:nth-of-type(2)").innerHTML = `
          <span class="label">장소:</span><br />
          ${obj.place || "장소 없음"}
        `;

        dialog.querySelector(".mini-popup .info:nth-of-type(3)").innerHTML = `
          <span class="label">메모:</span><br />
          ${obj.description || "메모 없음"}
        `;

        // 메모에서 상세페이지 보여주기
        document.getElementById("detail-dial").addEventListener("click", () =>{
          document.querySelector('input[name="title"]').value = obj.title;
          document.querySelector('textarea[name="description"]').value = obj.description;
          document.querySelector('select[name="place"]').value = obj.place;
          
          formPrint();
        })
    }
    
    function closeDialog(){
      document.getElementById("dialog").style.display = "none";
    }

    addEventListener("load", function () {
      let d = new Date();
      getCurrentTime(d.getFullYear(), d.getMonth());
      printTitle();
      createDayHeaders();
      createCell(); 
      miniCellPrint(); // 미니셸 보여주기

      document.getElementById("save_diary").addEventListener("click", function(){
        regist();
      });

      // 새 창 닫기 이벤트 구현
      document.getElementById("close-dial").addEventListener("click", () => {
        closeDialog();
      });

      document.getElementById("btn-today").addEventListener("click", () => {
        now();
      });


      // 공휴일 JSON 데이터 비동기식 Fetch로 불러오기
      fetch("./data.txt")
        .then(response => response.text())
        .then(text => {
          let obj = JSON.parse(text);
          restArray = obj.restList;
          printNum();
        })
        .catch(err => {
          console.error("공휴일 데이터 불러오기 실패", err);
          printNum(); // 데이터가 없어도 출력은 해야 함
        });

    });
  </script>
</head>
<body>
  <div id="wrapper">
    <div id="header"></div>
    <div id="container">
      <div id="aside_nav"></div>
      <div id="content">
        <div id="content_header">
          <div class="left-controls">
            <a href="javascript:prev()">← 이전</a>
            <h2>2025.05</h2>
            <a href="javascript:next()">다음 →</a>
            <button id="btn-today">오늘</button>
          </div>
        </div>
        <div id="date_print" ></div> 
        <div id="content_section">
          <div id="dialog" style="display: none;">
             <div class="mini-popup">
                <h4>일정</h4>
                <div class="info">
                  <span class="label">제목:</span><br />
                  나는제목
                </div>
                <div class="info">
                  <span class="label">장소:</span><br />
                  나는장소
                </div>
                <div class="info">
                  <span class="label">메모:</span><br />
                  나는디테일
                </div>
                <button id="close-dial">닫기</button>
                <button id="detail-dial">상세 정보</button>
            </div>  
          </div>
        </div>
        <div id="holder_header"></div>
        <div id="holder" style="display: none;">
          <form id="event-form" name="form1">
            <h3>새로운 일정 등록</h3>

            <label>
              제목  
              <input type="text" name="title" placeholder="제목을 입력하세요" />
            </label>

            <label>
              장소  
              <select name="place">
                <option value="">지역을 선택하세요</option>
                <option value="서울특별시">서울특별시</option>
                <option value="부산광역시">부산광역시</option>
                <option value="대구광역시">대구광역시</option>
                <option value="인천광역시">인천광역시</option>
                <option value="광주광역시">광주광역시</option>
                <option value="대전광역시">대전광역시</option>
                <option value="울산광역시">울산광역시</option>
                <option value="세종특별자치시">세종특별자치시</option>
                <option value="경기도">경기도</option>
                <option value="강원특별자치도">강원특별자치도</option>
                <option value="충청북도">충청북도</option>
                <option value="충청남도">충청남도</option>
                <option value="전라북도">전라북도</option>
                <option value="전라남도">전라남도</option>
                <option value="경상북도">경상북도</option>
                <option value="경상남도">경상남도</option>
                <option value="제주특별자치도">제주특별자치도</option>
              </select>
            </label>

            <label>
              일시  
              <div style="display: flex; gap: 5px;">
                <select name="year">
                  <option value="">년</option>
                  <script>
                    currentYear = new Date().getFullYear();
                    for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                      document.write(`<option value="${y}">${y}년</option>`);
                    }
                  </script>
                </select>
                <select name="month">
                  <option value="">월</option>
                  <script>
                    for (let m = 1; m <= 12; m++) {
                      document.write(`<option value="${m}">${m}월</option>`);
                    }
                  </script>
                </select>
                <select name="date">
                  <option value="">일</option>
                  <script>
                    for (let d = 1; d <= 31; d++) {
                      document.write(`<option value="${d}">${d}일</option>`);
                    }
                  </script>
                </select>
              </div>
            </label>


            <label>
              설명  
              <textarea name="description" rows="5" placeholder="설명을 입력하세요"></textarea>
            </label>

            <div class="form-buttons">
              <button type="button" class="save-btn" id="save_diary">저장</button>
              <button type="button" class="cancel-btn" onclick="form1.reset(); now();">취소</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div id="footer">
    </div>
  </div>
</body>
</html>
